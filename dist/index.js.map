{"version":3,"file":"index.js","sources":["../src/mentionPlugin.js","../src/nodes.js","../src/utils.js"],"sourcesContent":["import { Plugin, PluginKey } from \"prosemirror-state\";\nimport { Decoration, DecorationSet } from \"prosemirror-view\";\n\n/**\n *\n * @param {String} mentionTrigger\n * @param {String} hashtagTrigger\n * @param {bool} allowSpace\n * @returns {Object}\n */\nexport function getRegexp(mentionTrigger, hashtagTrigger, allowSpace) {\n  var mention = allowSpace\n    ? new RegExp(\"(^|\\\\s)\" + mentionTrigger + \"([\\\\w-\\\\+]+\\\\s?[\\\\w-\\\\+]*)$\")\n    : new RegExp(\"(^|\\\\s)\" + mentionTrigger + \"([\\\\w-\\\\+]+)$\");\n\n  // hashtags should never allow spaces. I mean, what's the point of allowing spaces in hashtags? <- Some tagged slide with a name -..-\n  var tag = allowSpace\n    ? new RegExp(\"(^|\\\\s)\" + hashtagTrigger + \"([\\\\w-\\\\+]*\\\\s?[\\\\w-\\\\+]*)$\")\n    : new RegExp(\"(^|\\\\s)\" + hashtagTrigger + \"([\\\\w-]*)$\");\n\n  return {\n    mention: mention,\n    tag: tag\n  };\n}\n\n/**\n *\n * @param {ResolvedPosition} $position https://prosemirror.net/docs/ref/#model.Resolved_Positions\n * @param {JSONObject} opts\n * @returns {JSONObject}\n */\nexport function getMatch($position, opts) {\n  // take current para text content upto cursor start.\n  // this makes the regex simpler and parsing the matches easier.\n  var parastart = $position.before();\n  const text = $position.doc.textBetween(parastart, $position.pos, \"\\n\", \"\\0\");\n\n  var regex = getRegexp(\n    opts.mentionTrigger,\n    opts.hashtagTrigger,\n    opts.allowSpace\n  );\n\n  // only one of the below matches will be true.\n  var mentionMatch = text.match(regex.mention);\n  var tagMatch = text.match(regex.tag);\n\n  var match = mentionMatch || tagMatch;\n\n  // set type of match\n  var type;\n  if (mentionMatch) {\n    type = \"mention\";\n  } else if (tagMatch) {\n    type = \"tag\";\n  }\n\n  // if match found, return match with useful information.\n  if (match) {\n    // adjust match.index to remove the matched extra space\n    match.index = match[0].startsWith(\" \") ? match.index + 1 : match.index;\n    match[0] = match[0].startsWith(\" \")\n      ? match[0].substring(1, match[0].length)\n      : match[0];\n\n    // The absolute position of the match in the document\n    var from = $position.start() + match.index;\n    var to = from + match[0].length;\n\n    var queryText = match[2];\n\n    return {\n      range: { from: from, to: to },\n      queryText: queryText,\n      type: type\n    };\n  }\n  // else if no match don't return anything.\n}\n\n/**\n * Util to debounce call to a function.\n * >>> debounce(function(){}, 1000, this)\n */\nexport const debounce = (function() {\n  var timeoutId = null;\n  return function(func, timeout, context) {\n    context = context || this;\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(function() {\n      func.apply(context, arguments);\n    }, timeout);\n\n    return timeoutId;\n  };\n})();\n\nvar getNewState = function() {\n  return {\n    active: false,\n    range: {\n      from: 0,\n      to: 0\n    },\n    type: \"\", //mention or tag\n    text: \"\",\n    suggestions: [],\n    index: 0 // current active suggestion index\n  };\n};\n\n/**\n * @param {JSONObject} opts\n * @returns {Plugin}\n */\nexport function getMentionsPlugin(opts) {\n  // default options\n  var defaultOpts = {\n    mentionTrigger: \"@\",\n    hashtagTrigger: \"#\",\n    allowSpace: true,\n    getSuggestions: (type, text, cb) => {\n      cb([]);\n    },\n    getSuggestionsHTML: items =>\n      '<div class=\"suggestion-item-list\">' +\n      items\n        .map(i => '<div class=\"suggestion-item\">' + i.name + \"</div>\")\n        .join(\"\") +\n      \"</div>\",\n    activeClass: \"suggestion-item-active\",\n    suggestionTextClass: \"prosemirror-suggestion\",\n    maxNoOfSuggestions: 10,\n    delay: 500\n  };\n\n  var opts = Object.assign({}, defaultOpts, opts);\n\n  // timeoutId for clearing debounced calls\n  var showListTimeoutId = null;\n\n  // dropdown element\n  var el = document.createElement(\"div\");\n\n  // current Idx\n  var index = 0;\n\n  // ----- methods operating on above properties -----\n\n  var showList = function(view, state, suggestions, opts) {\n    el.innerHTML = opts.getSuggestionsHTML(suggestions, state.type);\n\n    // attach new item event handlers\n    el.querySelectorAll(\".suggestion-item\").forEach(function(itemNode, index) {\n      itemNode.addEventListener(\"click\", function() {\n        select(view, state, opts);\n        view.focus();\n      });\n      // TODO: setIndex() needlessly queries.\n      // We already have the itemNode. SHOULD OPTIMIZE.\n      itemNode.addEventListener(\"mouseover\", function() {\n        setIndex(index, state, opts);\n      });\n      itemNode.addEventListener(\"mouseout\", function() {\n        setIndex(index, state, opts);\n      });\n    });\n\n    // highlight first element by default - like Facebook.\n    addClassAtIndex(state.index, opts.activeClass);\n\n    // get current @mention span left and top.\n    // TODO: knock off domAtPos usage. It's not documented and is not officially a public API.\n    // It's used currently, only to optimize the the query for textDOM\n    var node = view.domAtPos(view.state.selection.$from.pos);\n    var paraDOM = node.node;\n    var textDOM = paraDOM.querySelector(\".\" + opts.suggestionTextClass);\n\n    // TODO: should add null check case for textDOM\n    var offset = textDOM.getBoundingClientRect();\n\n    // TODO: think about outsourcing this positioning logic as options\n    document.body.appendChild(el);\n    el.style.position = \"fixed\";\n    el.style.zIndex = 100000;\n    el.style.left = offset.left + \"px\";\n\n    var top = textDOM.offsetHeight + offset.top;\n    el.style.top = top + \"px\";\n    el.style.display = \"block\";\n  };\n\n  var hideList = function() {\n    el.style.display = \"none\";\n  };\n\n  var removeClassAtIndex = function(index, className) {\n    var itemList = el.querySelector(\".suggestion-item-list\").childNodes;\n    var prevItem = itemList[index];\n    prevItem && prevItem.classList.remove(className);\n  };\n\n  var addClassAtIndex = function(index, className) {\n    var itemList = el.querySelector(\".suggestion-item-list\").childNodes;\n    var prevItem = itemList[index];\n    prevItem && prevItem.classList.add(className);\n  };\n\n  var setIndex = function(index, state, opts) {\n    removeClassAtIndex(state.index, opts.activeClass);\n    state.index = index;\n    addClassAtIndex(state.index, opts.activeClass);\n  };\n\n  var goNext = function(view, state, opts) {\n    removeClassAtIndex(state.index, opts.activeClass);\n    state.index++;\n    state.index = state.index === state.suggestions.length ? 0 : state.index;\n    addClassAtIndex(state.index, opts.activeClass);\n  };\n\n  var goPrev = function(view, state, opts) {\n    removeClassAtIndex(state.index, opts.activeClass);\n    state.index--;\n    state.index =\n      state.index === -1 ? state.suggestions.length - 1 : state.index;\n    addClassAtIndex(state.index, opts.activeClass);\n  };\n\n  var select = function(view, state, opts) {\n    var item = state.suggestions[state.index];\n    var node = view.state.schema.nodes[state.type].create(item);\n    var tr = view.state.tr.replaceWith(state.range.from, state.range.to, node);\n\n    var newState = view.state.apply(tr);\n    view.updateState(newState);\n  };\n\n  /**\n   * See https://prosemirror.net/docs/ref/#state.Plugin_System\n   * for the plugin properties spec.\n   */\n  return new Plugin({\n    key: new PluginKey(\"autosuggestions\"),\n\n    // we will need state to track if suggestion dropdown is currently active or not\n    state: {\n      init() {\n        return getNewState();\n      },\n\n      apply(tr, state) {\n        // compute state.active for current transaction and return\n        var newState = getNewState();\n        var selection = tr.selection;\n        if (selection.from !== selection.to) {\n          return newState;\n        }\n\n        const $position = selection.$from;\n        const match = getMatch($position, opts);\n\n        // if match found update state\n        if (match) {\n          newState.active = true;\n          newState.range = match.range;\n          newState.type = match.type;\n          newState.text = match.queryText;\n        }\n\n        return newState;\n      }\n    },\n\n    // We'll need props to hi-jack keydown/keyup & enter events when suggestion dropdown\n    // is active.\n    props: {\n      handleKeyDown(view, e) {\n        var state = this.getState(view.state);\n\n        // don't handle if no suggestions or not in active mode\n        if (!state.active && !state.suggestions.length) {\n          return false;\n        }\n\n        // if any of the below keys, override with custom handlers.\n        var down, up, enter, esc;\n        enter = e.keyCode === 13;\n        down = e.keyCode === 40;\n        up = e.keyCode === 38;\n        esc = e.keyCode === 27;\n\n        if (down) {\n          goNext(view, state, opts);\n          return true;\n        } else if (up) {\n          goPrev(view, state, opts);\n          return true;\n        } else if (enter) {\n          select(view, state, opts);\n          return true;\n        } else if (esc) {\n          clearTimeout(showListTimeoutId);\n          hideList();\n          this.state = getNewState();\n          return true;\n        } else {\n          // didn't handle. handover to prosemirror for handling.\n          return false;\n        }\n      },\n\n      // to decorate the currently active @mention text in ui\n      decorations(editorState) {\n        const { active, range } = this.getState(editorState);\n\n        if (!active) return null;\n\n        return DecorationSet.create(editorState.doc, [\n          Decoration.inline(range.from, range.to, {\n            nodeName: \"span\",\n            class: opts.suggestionTextClass\n          })\n        ]);\n      }\n    },\n\n    // To track down state mutations and add dropdown reactions\n    view() {\n      return {\n        update: view => {\n          var state = this.key.getState(view.state);\n          if (!state.active) {\n            hideList();\n            clearTimeout(showListTimeoutId);\n            return;\n          }\n          // debounce the call to avoid multiple requests\n          showListTimeoutId = debounce(\n            function() {\n              // get suggestions and set new state\n              opts.getSuggestions(state.type, state.text, function(\n                suggestions\n              ) {\n                // update `state` argument with suggestions\n                state.suggestions = suggestions;\n                showList(view, state, suggestions, opts);\n              });\n            },\n            opts.delay,\n            this\n          );\n        }\n      };\n    }\n  });\n}\n","/**\n * See https://prosemirror.net/docs/ref/#model.NodeSpec\n */\nexport const mentionNode = {\n  group: \"inline\",\n  inline: true,\n  atom: true,\n\n  attrs: {\n    id: \"\",\n    name: \"\",\n    email: \"\"\n  },\n\n  selectable: false,\n  draggable: false,\n\n  toDOM: node => {\n    return [\n      \"span\",\n      {\n        \"data-mention-id\": node.attrs.id,\n        \"data-mention-name\": node.attrs.name,\n        \"data-mention-email\": node.attrs.email,\n        class: \"prosemirror-mention-node\"\n      },\n      \"@\" + node.attrs.name || node.attrs.email\n    ];\n  },\n\n  parseDOM: [\n    {\n      // match tag with following CSS Selector\n      tag: \"span[data-mention-id][data-mention-name][data-mention-email]\",\n\n      getAttrs: dom => {\n        var id = dom.getAttribute(\"data-mention-id\");\n        var name = dom.getAttribute(\"data-mention-name\");\n        var email = dom.getAttribute(\"data-mention-email\");\n        return {\n          id: id,\n          name: name,\n          email: email\n        };\n      }\n    }\n  ]\n};\n\n/**\n * See https://prosemirror.net/docs/ref/#model.NodeSpec\n */\nexport const tagNode = {\n  group: \"inline\",\n  inline: true,\n  atom: true,\n\n  attrs: {\n    tag: \"\"\n  },\n\n  selectable: false,\n  draggable: false,\n\n  toDOM: node => {\n    return [\n      \"span\",\n      {\n        \"data-tag\": node.attrs.tag,\n        class: \"prosemirror-tag-node\"\n      },\n      \"#\" + node.attrs.tag\n    ];\n  },\n\n  parseDOM: [\n    {\n      // match tag with following CSS Selector\n      tag: \"span[data-tag]\",\n\n      getAttrs: dom => {\n        var tag = dom.getAttribute(\"data-tag\");\n        return {\n          tag: tag\n        };\n      }\n    }\n  ]\n};\n","import { tagNode, mentionNode } from \"./nodes\";\n\n/**\n *\n * @param {OrderedMap} nodes\n * @returns {OrderedMap}\n */\nexport function addMentionNodes(nodes) {\n  return nodes.append({\n    mention: mentionNode\n  });\n}\n\n/**\n *\n * @param {OrderedMap} nodes\n * @returns {OrderedMap}\n */\nexport function addTagNodes(nodes) {\n  return nodes.append({\n    tag: tagNode\n  });\n}\n"],"names":["getRegexp","mentionTrigger","hashtagTrigger","allowSpace","mention","RegExp","tag","getMatch","$position","opts","parastart","before","text","doc","textBetween","pos","regex","mentionMatch","match","tagMatch","type","index","startsWith","substring","length","from","start","to","queryText","debounce","timeoutId","func","timeout","context","setTimeout","apply","arguments","getNewState","getMentionsPlugin","defaultOpts","cb","items","map","i","name","join","Object","assign","showListTimeoutId","el","document","createElement","showList","view","state","suggestions","innerHTML","getSuggestionsHTML","querySelectorAll","forEach","itemNode","addEventListener","focus","activeClass","node","domAtPos","selection","$from","paraDOM","textDOM","querySelector","suggestionTextClass","offset","getBoundingClientRect","body","appendChild","style","position","zIndex","left","top","offsetHeight","display","hideList","removeClassAtIndex","className","itemList","childNodes","prevItem","classList","remove","addClassAtIndex","add","setIndex","goNext","goPrev","select","item","schema","nodes","create","tr","replaceWith","range","newState","updateState","Plugin","PluginKey","active","e","getState","down","up","enter","esc","keyCode","editorState","DecorationSet","Decoration","inline","key","getSuggestions","delay","mentionNode","attrs","id","email","dom","getAttribute","tagNode","addMentionNodes","append","addTagNodes"],"mappings":"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"}